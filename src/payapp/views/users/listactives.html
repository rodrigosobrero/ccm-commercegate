{% extends "main.html" %}
{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h4 class="page-header">Listado de Usuarios (Activos)</h4>
    </div>
    <!-- /.col-lg-12 -->
</div>

    <div class="row">
        <div class="col-xs-12 col-sm-12">

        <div class="panel panel-default">

              <div class="panel-body">
                <div class="row">
                  <div class="col-lg-6">
                      <form method="POST" action="{% url 'usersactives' %}">
                            <div class="input-group">
                              <span class="input-group-btn">
                                  <a class="btn btn-default" href="{% url 'usersactives' %}"><i class="glyphicon glyphicon-th-list"></i> Mostrar Todos</a>
                                <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-filter"></i> Buscar</button>

                              </span>
                              <input type="text" class="form-control" name="search" placeholder="Buscar...">
                            </div><!-- /input-group -->
                      </form>
                  </div><!-- /.col-lg-6 -->
                </div><!-- /.row -->


              <div class="row">
                <div class="col-xs-6 col-sm-6">
                {% if search %}
                <div class="alert alert-success alert-dismissible" role="default" style="list-style-type: none;">
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <strong>Filtrado Por:  {{ search }}</strong>
                </div>
                {% endif %}
                </div>
            </div>

          <br>

            <table class="table table-bordered">


                    <thead>
                        <th>ID <a href="?order_by=user_id&direction=asc" class="glyphicon glyphicon-arrow-up"></a>
                                    <a href="?order_by=user_id&direction=desc" class="glyphicon glyphicon-arrow-down"></a>
                        </th>

                        <th>Email <a href="?order_by=email&direction=asc" class="glyphicon glyphicon-arrow-up"></a>
                                    <a href="?order_by=email&direction=desc" class="glyphicon glyphicon-arrow-down"></a>
                        </th>

                        <th>Pais <a href="?order_by=country__name&direction=asc" class="glyphicon glyphicon-arrow-up"></a>
                                    <a href="?order_by=country__name&direction=desc" class="glyphicon glyphicon-arrow-down"></a>
                        </th>
                        <th>Expiracion <a href="?order_by=expiration&direction=asc" class="glyphicon glyphicon-arrow-up"></a>
                                       <a href="?order_by=expiration&direction=desc" class="glyphicon glyphicon-arrow-down"></a>
                        </th>

                        <th>Acciones</th>
                    </thead>
                   <tbody>
                    {% for item in registros %}
                    <tr>
                        <td>{{ item.user_id }}</td>
                        <td>{{ item.email }}</td>
                        <td>{{ item.country.name }}</td>

                        <td name="td_expiration" data-id="{{ item.user_id}}">
                            {{ item.expiration|date:'d/m/Y' }}
                        </td>

                        <td>
                            {% if item.is_active %}
                                <div class="btn btn-xs btn-default expirar"  data-id="{{ item.user_id }}"><i class="glyphicon glyphicon-hourglass"></i> Expirar</div>
                            {% endif %}
                            <a href="/ui/userpayments/{{item.user_id}}" class="btn btn-xs btn-default"><i class="glyphicon glyphicon-credit-card"></i> Recurrencias</a>

                        </td>
                    </tr>
                   {% endfor %}
                   </tbody>
                   </table>


        <nav aria-label="Page navigation">
          <ul class="pagination">
                   {% if registros.has_previous %}
                  <li>
                      <a href="?page={{ registros.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>
                  {% else %}
                     <li class="disabled"><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
                {% endif %}



                {% for i in registros.paginator.page_range %}
                  {% if registros.number == i %}
                    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                  {% else %}
                    <li><a href="?page={{ i }}">{{ i }}</a></li>
                  {% endif %}
                {% endfor %}



               {% if registros.has_next %}
                <li>
                  <a href="?page={{ registros.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% else %}
                 <li class="disabled">
                     <a href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                 </li>
            {% endif %}
          </ul>
        </nav>
        <ol class="breadcrumb">
            <li><p class="navbar-text navbar-right">Total de Registros: {{ registros.paginator.count }}</p>   </li>
        </ol>
        </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function() {

        $(".btn.btn-default.expirar").click(function(){
                var registro = $(".btn.btn-default.expirar");
                var user_id = registro.attr("data-id");

                if(confirm("Â¿Seguro desea expirar el Usuario?")){
                    expirar(user_id);
                };


        });

        function expirar(user_id){

                url = "/ui/expireuser"
                json_data= {
                        "user_id": user_id,
                };


                $.ajax({
                    url: url,
                    dataType: 'json',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify( json_data ),
                    success: function(response){
                            respuesta = response.data;

                            //leer el tiempo
                            //var strselector = "td[name='td_expiration'][data-id="+user_id+"]";

                            window.location.href = "/ui/users/";





                        },
                    error:function(request, status, error){

                        alert(request.responseText);

                    }
                });
        };


    });



</script>
{% endblock %}



